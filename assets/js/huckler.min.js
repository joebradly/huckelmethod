function keydown(a){if(a=a||window.event,(65==a.keyCode||69==a.keyCode)&&model.draw.toggle(),38==a.keyCode&&(spectrum.selectNext(1),a.preventDefault()),40==a.keyCode&&(spectrum.selectNext(-1),a.preventDefault()),8==a.keyCode){var b=$(document.activeElement).is("input");model.selected===!1||b||$("#delete").trigger("click"),b||a.preventDefault()}console.log(a.keyCode)}function keyup(){}function reset(){editor.reset(),model.reset(),spectrum.reset()}function Editor(a){var b=this;this.container=$("#"+a),this.setup={node:{range:[-10,10]},link:{range:[-4,4]}},this.edit=function(a,c){this.reset();for(var d=$("<input type=range min="+this.setup[a].range[0]+" max="+this.setup[a].range[1]+" value="+model.get(a,c).weight+' step=0.05 list="weight_list" />'),e=$('<datalist id="weight_list"></datalist>'),f=this.setup[a].range[0];f<=this.setup[a].range[1];f++)e.append($("<option>"+f+"</option>"));var g=$("<input id='weight' type='text' size=6 value='"+model.get(a,c).weight+"'/>"),h=$('<a id="delete" class="button" data-editor="'+c+'"> Delete<a/>');this.container.append($("<h3>Edit "+a+"</h3>")).append($("<form/>").append("Weight: ").append(d).append(e).append(g).append(h)),d=d.on("input change",function(){data=$(this).val(),Math.abs(g.val()-data)>.01&&g.val(data),model.update(a,c,data)}),g.bind("input paste",function(){$.isNumeric($(this).val())&&d.val(parseFloat($(this).val())).trigger("input")}),h.on("click",function(){model.unselect(),model.remove(a,c),b.reset()})},this.reset=function(){this.container.html("")}}function Model(a){var b=this;this.nodes={};var c=0;this.links={};var d=0,e=!1;this.draw=new DrawMode($("#drawmode")),this.diag=new DrawMode($("#diagmode")),this.tran=new DrawMode($("#tranmode")),this.transport=!1,this.selected=!1;var f=new Kinetic.Stage({container:a,width:520,height:405}),g=new Kinetic.Layer,h=new Kinetic.Layer,i=new Kinetic.Layer;f.add(h),f.add(i),f.add(g),f.getContainer().addEventListener("mousedown",function(a){b.clearEigen(),b.draw.mode?b.add_node(a.offsetX|a.layerX,a.offsetY|a.layerY):b.selected!==!1&&b.unselect()}),this.write=function(a){e===!1?void 0!==a&&(e=new Kinetic.Text({x:10,y:10,text:a,fontSize:16,fontFamily:"Arial",fill:"gray"}),h.add(e)):void 0===a?(e.destroy(),e=!1):e.setText(a),h.batchDraw()},this.add_node=function(a,e,f,g){void 0===f&&(f=0),void 0===g&&(g={});var h=!0;"draggable"in g&&(h=g.draggable);var j="gray";0>f&&(j="black");var k=new Kinetic.Circle({x:a,y:e,radius:14+1.5*Math.abs(f),fill:j,stroke:"rgb(255,255,255)",strokeWidth:4,draggable:h,name:"node",id:"node"+c});return b.nodes[k.getId()]={x:a,y:e,links:Array(),weight:f,options:g},k.on("mouseover",function(){document.body.style.cursor="pointer"}),k.on("mouseout",function(){document.body.style.cursor=b.draw.mode?"copy":"default"}),k.on("mousedown touchstart",function(a){b.touch_circle(this),a.cancelBubble=!0}),k.on("dragstart",function(){b.unselect(this),document.body.style.cursor="pointer"}),k.on("dragmove",function(){b.nodes[this.getId()].x=this.getX(),b.nodes[this.getId()].y=this.getY(),b.update_links(b.nodes[this.getId()].links)}),i.add(k),c++,i.batchDraw(),b.selected!==!1&&"Circle"==b.selected.getClassName()&&(b.add_link(this.selected.getId(),k.getId()),b.unselect(this.selected)),0===d&&b.write("Select two nodes to add a link between them."),"electrode"in g||"load"in g||b.touch_circle(k),k.getId()},this.touch_circle=function(a){if(this.selected!==!1&&"node"==this.selected.getName())if(this.selected.getId()==a.getId())this.unselect();else{var b=this.test_link(a.getId(),this.selected.getId());b===!1&&this.draw.mode&&(b=this.add_link(a.getId(),this.selected.getId()),this.unselect()),b!==!1&&b!==!0?this.touch_line(h.get("#"+b)[0]):this.select(a)}else this.select(a)},this.update_node=function(a,b){if(this.nodes[a].weight!=b){this.nodes[a].weight=b;var c=i.get("#"+a)[0];c.setRadius(14+1.5*Math.abs(b)),b>=0?c.setFill("gray"):c.setFill("black"),i.batchDraw(),this.evaluate()}},this.remove_node=function(a){iselectrode=this.is_electrode(a),console.log("remove "+a);for(var c=b.nodes[a].links.slice(0),d=0;d<c.length;++d)b.remove_link(c[d]);delete b.nodes[a];var e=i.get("#"+a)[0];e.destroy(),i.batchDraw(),iselectrode||this.evaluate()},this.add_electrodes=function(){var a=f.getHeight(),b=f.getWidth();this.add_node(0,a/2,10,{electrode:!0,draggable:!1}),this.add_node(b,a/2,10,{electrode:!0,draggable:!1}),console.log("Added electrodes")},this.get_electrodes=function(){var a=[];for(var b in this.nodes)this.nodes.hasOwnProperty(b)&&this.nodes[b].options.electrode===!0&&a.push(b);return a},this.remove_electrodes=function(){for(var a=this.get_electrodes(),b=0;b<a.length;b++)this.remove_node(a[b])},this.is_electrode=function(a){return"electrode"in model.nodes[a].options&&model.nodes[a].options.electrode===!0?!0:!1},this.test_link=function(a,c){if(a==c)return!0;for(var d=0;d<b.nodes[a].links.length;d++)if(lid=b.nodes[a].links[d],b.links[lid].nodes[0]==c||b.links[lid].nodes[1]==c)return lid;return!1},this.add_link=function(a,c,e){if(a==c)return!0;if(!this.test_link(a,c)){var f="black";void 0===e&&(e=-1,e>=0&&(f="gray"));var g=new Kinetic.Line({points:[b.nodes[a].x,b.nodes[a].y,b.nodes[c].x,b.nodes[c].y],stroke:f,strokeWidth:Math.abs(7*e),name:"link",id:"link"+d});return g.on("mousedown touchstart",function(a){b.touch_line(this),a.cancelBubble=!0}),console.log("added "+g.getId()+" between "+a+" and "+c),0===d&&b.write("Hover over the Eigenspectrum to show the orbitals"),h.add(g),d++,b.links[g.getId()]={nodes:[a,c],weight:e},b.nodes[a].links[b.nodes[a].links.length]=g.getId(),b.nodes[c].links[b.nodes[c].links.length]=g.getId(),(this.is_electrode(a)||this.is_electrode(c))&&g.dash([20,10]),h.batchDraw(),this.evaluate(),g.getId()}},this.touch_line=function(a){this.selected!==!1?a.getId()==this.selected.getId()?this.unselect(this.selected):(this.unselect(this.selected),this.select(a)):this.selected===!1&&this.select(a)},this.update_links=function(a,b){for(var c=0;c<a.length;c++)this.update_link(a[c],b)},this.update_link=function(a,c){if(void 0===c){var d=b.links[a].nodes[0],e=b.links[a].nodes[1];line=h.get("#"+a)[0],line.setPoints([b.nodes[d].x,b.nodes[d].y,b.nodes[e].x,b.nodes[e].y])}else{if(this.links[a].weight==c)return;this.links[a].weight=c,line=h.get("#"+a)[0],line.setStrokeWidth(Math.abs(7*c)),c>=0?line.setStroke("gray"):line.setStroke("black"),this.evaluate()}h.batchDraw()},this.remove_link=function(a){this.selected=!1;var b=h.get("#"+a)[0];b.destroy(),console.log("remove "+a+" from "+this.links[a].nodes[0]+" to "+this.links[a].nodes[1]);for(var c=0;2>c;c++){var d=this.links[a].nodes[c],e=this.nodes[d].links,f=e.indexOf(a);f>-1&&e.splice(f,1),this.nodes[d].links=e}delete this.links[a],h.batchDraw(),this.evaluate()},this.add=function(a,b,c,d){return"link"==a?this.add_link(b,c,d):this.add_node(b,c,d)},this.update=function(a,b,c){return"link"==a?this.update_link(b,c):this.update_node(b,c)},this.select=function(a){(this.selected===!1||this.selected.getId()!=a.getId())&&(this.clearEigen(),this.unselect(),this.selected=a,this.selected.setStroke("#CC3333"),"link"==this.selected.getName()?(h.batchDraw(),editor.edit("link",a.getId())):(i.batchDraw(),this.is_electrode(a.getId())||editor.edit("node",a.getId())),console.log("selected "+a.getId()))},this.unselect=function(){this.selected!==!1&&(editor.reset(),"link"==this.selected.getName()?(this.links[this.selected.getId()].weight<=0?this.selected.setStroke("black"):this.selected.setStroke("gray"),h.batchDraw()):(this.selected.setStroke("rgb(255,255,255)"),i.batchDraw()),this.selected=!1)},this.get=function(a,b){return"link"==a?this.links[b]:this.nodes[b]},this.remove=function(a,b){return"link"==a?this.remove_link(b):this.remove_node(b)},this.reset=function(){g.destroyChildren().draw(),h.destroyChildren().draw(),i.destroyChildren().draw(),this.nodes={},c=0,this.links={},d=0,this.selected=!1,e=!1,this.draw.reset(),this.diag.reset(),this.tran.reset(),this.remove_electrodes(),$("#electrodes").html("<b>+</b> Leads").attr("data-mode","add"),b.write("Click the canvas to add nodes to your model.")},this.clearEigen=function(){spectrum.unselect(),g.destroyChildren().draw()},this.drawMO=function(a,b,c){g.destroyChildren();for(var d=c.length,e=sign(c[0]),f=0;d>f;f++){var h=this.nodes[a[f]];this.drawMOweight(h.x,h.y,e*c[f])}this.write("Energy: "+Math.round(1e3*b)/1e3),g.batchDraw()},this.drawMOweight=function(a,b,c){var d="blue";0>c&&(d="red");var e=new Kinetic.Circle({x:a,y:b,radius:42*Math.abs(c),fill:d,draggable:!1});g.add(e)},this.evaluate=function(a){this.diag.mode?(this.write(""),spectrum.diagonalize()):(this.clearEigen(),spectrum.reset()),this.tran.mode?transport.plot():transport.reset(),a="undefined"!=typeof a?a:!1,a||$("#modellink").html("")},this.connections=function(){var a=[],b=[],c=[];for(var d in model.nodes)model.nodes.hasOwnProperty(d)&&(model.nodes[d].links.length>0&&b.push(d),model.is_electrode(d)&&c.push(d));for(var e=0;e<c.length;e++){a[e]=[];for(var f=0;f<model.nodes[c[e]].links.length;f++){var g=model.nodes[c[e]].links[f],h=0;model.links[g].nodes[0]==c[e]&&(h=1),a[e].push([b.indexOf(model.links[g].nodes[h]),parseFloat(model.links[g].weight)])}}return a},this.dump=function(){var a=spectrum.hamiltonian(this);if(a===!1)return!1;for(var b=[],c=model.connections(),d=0;d<spectrum.inodes.length;d++)a[d][d]=a[d][d]-spectrum.settings.adhocshift,b[d]=[this.nodes[spectrum.inodes[d]].x,this.nodes[spectrum.inodes[d]].y];var e=JSON.stringify({H:a,xy:b,L:c},null,null);return e},this.load=function(a,b,c){reset(),spectrum.update=!1;for(var d=[],e=0;e<b.length;e++)d[e]=this.add_node(b[e][0],b[e][1],a[e][e],{load:!0});for(var e=0;e<b.length;e++)for(var f=0;e>f;f++)0!==a[e][f]&&this.add_link(d[e],d[f],parseFloat(a[e][f]));if(c.length>0){model.add_electrodes(),$("#electrodes").html("<b>&ndash;</b> Leads"),els=model.get_electrodes();for(var e=0;2>e;e++)for(var f=0;f<c[e].length;f++)model.add_link(els[e],d[c[e][f][0]],parseFloat(c[e][f][1]))}spectrum.update=!0,spectrum.diagonalize(),transport.plot(),this.tran.toggle(),this.diag.toggle()},this.loadFromString=function(a){try{var c=$.parseJSON(a);return b.load(c.H,c.xy,c.L)}catch(d){return}}}function Spectrum(a){var b=this;this.inodes=[],this.energies=[],this.orbitals=[],this.selected=!1,this.update=!0,this.settings={adhocshift:10};var c=new Kinetic.Stage({container:a,width:250,height:180}),d=new Kinetic.Layer,e=new Kinetic.Layer;c.add(d),c.add(e),this.hamiltonian=function(a){this.inodes=[];for(var b in a.nodes)if(a.nodes.hasOwnProperty(b)&&a.nodes[b].links.length>0){if(a.is_electrode(b))continue;this.inodes.push(b)}var c=this.inodes.length;if(2>c)return!1;if(0===c)return!1;for(var d=[],e=0;c>e;e++){d[e]=[];for(var f=0;c>f;f++)d[e][f]=0}for(e=0;c>e;e++){d[e][e]=parseFloat(a.nodes[this.inodes[e]].weight)+spectrum.settings.adhocshift;for(var g=0;g<a.nodes[this.inodes[e]].links.length;++g){var h=a.nodes[this.inodes[e]].links[g],i=this.inodes.indexOf(a.links[h].nodes[0]),j=this.inodes.indexOf(a.links[h].nodes[1]);-1!==i&&-1!==j&&(d[i][j]=parseFloat(a.links[h].weight),d[j][i]=parseFloat(a.links[h].weight))}}return d},this.diagonalize=function(){if(this.update!==!1){var a=this.hamiltonian(model);if(a===!1)return model.clearEigen(),this.reset(),void 0;console.log("diagonalize model");var c=numeric.eig(a,1e5),e=range(0,c.lambda.x.length-1);e.sort(function(a,b){return c.lambda.x[a]<c.lambda.x[b]?-1:1}),this.energies=[],this.orbitals=[];for(var f=0;f<e.length;f++){var g=e[f];this.energies[f]=c.lambda.x[g]-spectrum.settings.adhocshift,this.orbitals[f]=[];for(var h=0;h<e.length;h++)this.orbitals[f][h]=c.E.x[h][g]}var i=Math.max.apply(null,this.energies),j=Math.min.apply(null,this.energies),k=Math.max(i,Math.abs(j)),l=!1;this.selected!==!1&&(l=this.selected.getId()),this.selected=!1,d.destroyChildren();var m="black";for(f=0;f<this.energies.length;f++){var n=new Kinetic.Group({id:"E"+f});m="black",l!==!1&&l=="E"+f&&(m="red");var o=new Kinetic.Line({points:[25,140*(-f/(this.energies.length-1))+160,50,70*(-this.energies[f]/k)+90,170,70*(-this.energies[f]/k)+90],stroke:m,strokeWidth:3}),p=new Kinetic.Circle({x:25,y:140*(-f/(this.energies.length-1))+160,radius:Math.min(Math.round(90/this.energies.length)-1,10),fill:m,stroke:m});n.add(o),n.add(p),n.on("mouseover touchstart",function(){b.select(this)}),d.add(n)}b.drawControls(),d.batchDraw(),l!==!1&&(l=d.get("#"+l)[0],b.select(l))}},this.drawControls=function(){if(!(e.getChildren().length>0)){var a=new Image,c=new Kinetic.Image({x:180,y:20,image:a,width:60,height:60});a.src="./assets/img/interface-02.png",c.on("touchstart mousedown",function(){b.selectNext(1)});var d=new Image,f=new Kinetic.Image({x:180,y:98,image:d,width:60,height:60});d.src="./assets/img/interface-01.png",f.on("touchstart mousedown",function(){b.selectNext(-1)}),e.add(c),e.add(f),e.batchDraw()}},this.select=function(a){var b=parseInt(a.getId().slice(1),10);(this.selected===!1||this.selected.getId()!=a.getId())&&(model.drawMO(this.inodes,this.energies[b],this.orbitals[b]),this.kineticGroupSetStroke(a,"red"),this.unselect(),this.selected=a)},this.selectNext=function(a){$(document.activeElement).blur();var c=a>0?0:b.energies.length+a;b.selected!==!1&&(0>a?(c=parseInt(b.selected.getId().slice(1),10)+a,c=0>c?b.energies.length-1:c):c=(parseInt(b.selected.getId().slice(1),10)+1)%b.energies.length),b.unselect(),b.select(d.get("#E"+c)[0],c)},this.unselect=function(){this.selected!==!1&&this.kineticGroupSetStroke(this.selected,"black"),this.selected=!1,d.batchDraw()},this.kineticGroupSetStroke=function(a,b){for(var c=a.getChildren(),d=0;d<c.length;d++)c[d].setFill(b),c[d].setStroke(b)},this.reset=function(){this.inodes=[],this.energies=[],this.orbitals=[],this.unselect(),d.destroyChildren().draw(),e.destroyChildren().draw()}}function Transport(){this.plot=function(){var a=[this.calculate()];if(a!==!1){0==$("#huckler_transport h3").length&&$("#huckler_transport").append($("<h3></h3>").html("log[ (E &ndash; H)<sup>-2</sup> ]")).append($('<div id="transport_plot"></div')).append($("<span>E</span>"));var b={selection:{mode:"xy"}};$.plot("#transport_plot",a,b),$("#huckler_transport").bind("plotselected",function(c,d){d.xaxis.to-d.xaxis.from<1e-5&&(d.xaxis.to=d.xaxis.from+1e-5),d.yaxis.to-d.yaxis.from<1e-5&&(d.yaxis.to=d.yaxis.from+1e-5),$.plot("#transport_plot",a,$.extend(!0,{},b,{xaxis:{min:d.xaxis.from,max:d.xaxis.to},yaxis:{min:d.yaxis.from,max:d.yaxis.to}}))})}},this.calculate=function(a){spectrum.energies.length>1&&spectrum.diagonalize(),void 0===a&&(a=[Math.min.apply(null,spectrum.energies),Math.max.apply(null,spectrum.energies)]);var b=model.get_electrodes();if(b.length<2)return!1;if(model.nodes[b[0]].links.length<1||model.nodes[b[1]].links.length<1)return!1;var c=numeric.linspace(a[0],a[1],600),d=this.resolvent(c,b);return numeric.transpose([c,d])},this.resolvent=function(a,b){for(var c=spectrum.hamiltonian(model),d=newFilledArray(spectrum.energies.length,0),e=model.nodes[b[0]],f=0;f<e.links.length;f++){var g=0;model.links[e.links[f]].nodes[0]==b[0]&&(g=1),d[spectrum.inodes.indexOf(model.links[e.links[f]].nodes[g])]=model.links[e.links[f]].weight}for(var h=newFilledArray(spectrum.energies.length,0),i=model.nodes[b[1]],j=0;j<i.links.length;j++){var k=0;model.links[i.links[j]].nodes[0]==b[1]&&(k=1),h[spectrum.inodes.indexOf(model.links[i.links[j]].nodes[k])]=model.links[i.links[j]].weight}for(var l=Array(a.length),m=numeric.identity(spectrum.energies.length),n=0;n<a.length;n++)l[n]=Math.log(Math.abs(numeric.dot(d,numeric.solve(numeric.add(numeric.mul(-a[n]-spectrum.settings.adhocshift,m),c,!1),h))));return l},this.reset=function(){$("#huckler_transport").html("")}}function DrawMode(a,b){var c=this;this.mode=!1,this.button=a.click(function(){c.toggle(),void 0!==b&&b()}),this.toggle=function(){this.mode=!this.mode,this.mode===!0?(document.body.style.cursor="copy",this.button.html("ON"),this.button.addClass("toggle")):(document.body.style.cursor="default",this.button.html("OFF"),this.button.removeClass("toggle"))},this.reset=function(){this.mode=!1,document.body.style.cursor="default",this.button.removeClass("toggle"),this.button.html("OFF")}}function range(a,b,c,d){for(d=[],c=b-a+1;c--;)d[c]=b--;return d}function sign(a){return 0>a?-1:1}function newFilledArray(a,b){for(var c=[],d=0;a>d;d++)c[d]=b;return c}function zeros(a,b){for(var c=[],d=0;a>d;d++){c[d]=[];for(var e=0;b>e;e++)c[d][e]=0}return c}function ring(a){for(var b=zeros(a,a),c=0;a>c;c++)b[c][(c+1)%a]=-1,b[(c+1)%a][c]=-1;for(var d=520,e=405,f=[],g=parseFloat(a),h=d/6+2*g,c=0;a>c;c++)f[c]=[Math.round(d/2+h*Math.cos(2*c*Math.PI/g)),Math.round(e/2+h*Math.sin(2*c*Math.PI/g))];var i=[],j=JSON.stringify({H:b,xy:f,L:i},null,null);return j}function chain(a,b){isNaN(b)&&(b=-1);for(var c=zeros(a,a),d=0;a-1>d;d++)0==d%2?(c[d][d+1]=-b,c[d+1][d]=-b):(c[d][d+1]=-1,c[d+1][d]=-1);for(var e=520,f=405,g=[],h=parseFloat(a),d=0;a>d;d++){var i=-25;0==d%2&&(i=-i);var j=10/h+e/5.8-4.3*h;g[d]=[Math.round(e/2+j/2+j*(d-a/2)),Math.round(f/2+i)]}var k=[],l=JSON.stringify({H:c,xy:g,L:k},null,null);return l}$("#huckler").append($('<div id="huckler_model"  class="huckler_model"></div>')).append($('<div id="huckler_editor" class="huckler_editor"></div>')).append($('<div id="huckler_spectrum" class="huckler_spectrum"></div>')).append($('<div id="huckler_transport" class="huckler_transport"></div>'));var model=new Model("huckler_model");model.write("Click the canvas to add nodes to your model.");var editor=new Editor("huckler_editor"),spectrum=new Spectrum("huckler_spectrum"),transport=new Transport("huckler_transport");document.onkeydown=keydown,document.onkeyup=keyup;